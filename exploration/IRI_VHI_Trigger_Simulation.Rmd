---
title: "Trigger Simulation"
output: html_document
date: "2023-09-26"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(targets)
library(tidyverse)
library(gghdx)
gghdx()
tar_load(df_cropland_lte_vhi_threshold)
tar_load(df_iri_adm0)

vhi_thresh <- 0.35
area_thresh <-  0.25
iri_pbavg_thresh <- 0.42
```



```{r}

# tak max probability (bavg) across leadtimes
df_iri_adm0_max <- df_iri_adm0 %>% 
  group_by(
    across(starts_with("adm")), 
    predict_start_mo, seas
  ) %>% 
  summarise(
    across(.cols= c("mean","median"), ~max(.x/100))
  ) 

# filter to just relevant seasons
df_iri_adm0_max_relevant_season <- df_iri_adm0_max %>% 
  ungroup() %>% 
  filter(
    str_detect(seas,"MJJ|JJA|SON")
  ) 
```


```{r}
library(gt)
df_iri_adm0_max_relevant_season %>% 
  group_by(across(starts_with("adm")),seas) %>% 
  mutate(
    flag_thresh = mean>=iri_pbavg_thresh
  ) %>% 
  # filter(flag_thresh) %>% 
  ungroup() %>% 
  select(adm0_es,Season=seas,mean) %>% 
  pivot_wider(
    names_from = adm0_es,
    values_from=mean
  ) %>% 
  gt::gt() %>% 
  gt::fmt_number(decimals=2) %>% 
  data_color(
    columns= `Guatemala`,
    rows = `Guatemala`>=iri_pbavg_thresh,
    palette= c(hdx_hex("tomato-light"), hdx_hex("tomato-dark"))
  ) %>% 
  data_color(
    columns= `El Salvador`,
    rows =`El Salvador`>=iri_pbavg_thresh,
    palette= c(hdx_hex("tomato-light"), hdx_hex("tomato-dark"))
  ) %>% 
  data_color(
    columns= `Nicaragua`,
    rows =`Nicaragua`>=iri_pbavg_thresh,
    palette= c(hdx_hex("tomato-light"), hdx_hex("tomato-dark"))
  ) %>% 
  data_color(
    columns= `Honduras`,
    rows =`Honduras`>=iri_pbavg_thresh,
    palette= c(hdx_hex("tomato-light"), hdx_hex("tomato-dark"))
  )

```

```{r}
df_iri_adm0_max_relevant_season %>% 
  group_by(across(starts_with("adm")),seas) %>% 
  mutate(
    flag_thresh = mean>=iri_pbavg_thresh
  ) %>% 
  # filter(flag_thresh) %>% 
  ungroup() %>% 
  ggplot(
    aes(x= seas,y=adm0_es,fill=mean)
  )+
  geom_tile()+
  scale_fill_binned(
    type="viridis",
    breaks = c(0,iri_pbavg_thresh,1)
  )+
  theme(
    axis.text.x = element_text(angle=90)
  )
```

add one highlighting if vhi threshold was reached in relevant season as well

---
title: "Sanity Check: INSIVUMEH Special Models Data Reading"
format: html
---

## Overview

Verifies that INSIVUMEH NetCDF files are being read and processed correctly.

**Key checks:**

1. Array transposition (`aperm`) is correct for spatial alignment
2. Values are in expected units (mm/month)
3. Dates/leadtimes extracted correctly from NC attributes

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(terra)
library(sf)
library(RNetCDF)
library(ncmeta)
library(lubridate)
library(cumulus)
library(janitor)
```

```{r}
#| label: config

forecast_dir <- file.path(
  Sys.getenv("AA_DATA_DIR_NEW"),
  "private/raw/lac/INSIVUMEH/special_forecast_historical_20260112",
  "pronosticos historicos"
)

# Load Chiquimula boundary
sf_gtm_adm1 <- cumulus::download_fieldmaps_sf(iso3 = "GTM", layer = "gtm_adm1")$gtm_adm1
chiquimula <- sf_gtm_adm1 |> clean_names() |> filter(adm1_pcode == "GT20")
```

```{r}
#| label: helper-functions

r_extent <- function(nc_ob) {
  lat <- var.get.nc(nc_ob, "Y")
  lon <- var.get.nc(nc_ob, "X")
  dx <- diff(lon[1:2])
  dy <- abs(diff(lat[1:2]))
  c(min(lon) - dx/2, max(lon) + dx/2, min(lat) - dy/2, max(lat) + dy/2)
}

load_insivumeh_nc <- function(fp, transpose = TRUE) {
  dat <- open.nc(fp)
  dat_extent <- r_extent(dat)
  value_array <- var.get.nc(dat, "deterministic")

  if (transpose) {
    value_array <- aperm(value_array, c(2, 1))
  }

  close.nc(dat)
  rast(x = value_array, ext = dat_extent, crs = "OGC:CRS84")
}
```

## Check 1: Array Transposition

The raw NetCDF has dimensions (T, Y, X). When loaded into R, the array needs to be transposed with `aperm(c(2, 1))` for correct spatial alignment in terra.

```{r}
#| label: check-transpose
#| fig-width: 12
#| fig-height: 5

fp_test <- file.path(
  forecast_dir,
  "CFSv2_PRCP/2020/starJun/MME_deterministic_forecast_Aug_Jun2020_L2.nc"
)

r_no_transpose <- load_insivumeh_nc(fp_test, transpose = FALSE)
r_with_transpose <- load_insivumeh_nc(fp_test, transpose = TRUE)

cat("Without transpose: nrow =", nrow(r_no_transpose), ", ncol =", ncol(r_no_transpose), "\n")
cat("With transpose:    nrow =", nrow(r_with_transpose), ", ncol =", ncol(r_with_transpose), "\n")

par(mfrow = c(1, 2))
plot(r_no_transpose, main = "NO transpose (WRONG)", col = hcl.colors(50, "Blues", rev = TRUE))
plot(st_geometry(chiquimula), add = TRUE, border = "red", lwd = 2)

plot(r_with_transpose, main = "WITH transpose (CORRECT)", col = hcl.colors(50, "Blues", rev = TRUE))
plot(st_geometry(chiquimula), add = TRUE, border = "red", lwd = 2)
```

**Result:** WITH transpose shows correct Guatemala shape. Chiquimula (red) is correctly positioned in SE Guatemala.

## Check 2: Model Comparison

All three models (CFSv2, CCSM4, CESM1) should show similar spatial patterns for the same month.

```{r}
#| label: check-models
#| fig-width: 14
#| fig-height: 5

par(mfrow = c(1, 3))
for (model in c("CFSv2", "CCSM4", "CESM1")) {
  fp <- file.path(
    forecast_dir,
    paste0(model, "_PRCP/2020/starJun/MME_deterministic_forecast_Aug_Jun2020_L2.nc")
  )
  r <- load_insivumeh_nc(fp)

  cat(model, "- min:", round(minmax(r)[1], 1), "max:", round(minmax(r)[2], 1), "mm\n")

  plot(r, main = paste(model, "- Aug 2020"), col = hcl.colors(50, "Blues", rev = TRUE))
  plot(st_geometry(chiquimula), add = TRUE, border = "red", lwd = 2)
}
```

**Result:** All models show similar spatial patterns with higher precip in highlands and Caribbean slopes.

## Check 3: Seasonal Comparison

Dry season (February) should show much lower values than rainy season (August).

```{r}
#| label: check-seasonal
#| fig-width: 10
#| fig-height: 5

fp_feb <- file.path(forecast_dir, "CFSv2_PRCP/2020/starJan/MME_deterministic_forecast_Feb_Jan2020_L1.nc")
fp_aug <- file.path(forecast_dir, "CFSv2_PRCP/2020/starJun/MME_deterministic_forecast_Aug_Jun2020_L2.nc")

r_feb <- load_insivumeh_nc(fp_feb)
r_aug <- load_insivumeh_nc(fp_aug)

cat("February (dry season): Range", round(minmax(r_feb)[1], 1), "-", round(minmax(r_feb)[2], 1), "mm\n")
cat("August (rainy season): Range", round(minmax(r_aug)[1], 1), "-", round(minmax(r_aug)[2], 1), "mm\n")

par(mfrow = c(1, 2))
plot(r_feb, main = "February 2020 (Dry)", col = hcl.colors(50, "Blues", rev = TRUE), range = c(0, 400))
plot(st_geometry(chiquimula), add = TRUE, border = "red", lwd = 2)

plot(r_aug, main = "August 2020 (Rainy)", col = hcl.colors(50, "Blues", rev = TRUE), range = c(0, 400))
plot(st_geometry(chiquimula), add = TRUE, border = "red", lwd = 2)
```

**Result:** February shows ~0-237mm, August shows ~111-742mm. Seasonal pattern is correct.

## Check 4: Date/Leadtime Extraction

Verify that dates are extracted correctly from NC attributes and leadtime calculation matches filename.

```{r}
#| label: check-dates

files_to_check <- c(
  "CFSv2_PRCP/2020/starJan/MME_deterministic_forecast_Feb_Jan2020_L1.nc",
  "CFSv2_PRCP/2020/starJan/MME_deterministic_forecast_Apr_Jan2020_L3.nc",
  "CFSv2_PRCP/2020/starJan/MME_deterministic_forecast_Jul_Jan2020_L6.nc",
  "CFSv2_PRCP/2020/starMar/MME_deterministic_forecast_May_Mar2020_L2.nc"
)

results <- map_dfr(files_to_check, \(f) {
  fp <- file.path(forecast_dir, f)
  fname <- basename(fp)

  valid_time_meta <- nc_att(fp, "T", "units")$value[[1]]
  start_time_meta <- nc_att(fp, "S", "units")$value[[1]]

  valid_date <- as_date(str_extract(valid_time_meta, "[0-9]{4}-[0-9]{2}-[0-9]{2}"))
  pub_date <- as_date(str_extract(start_time_meta, "[0-9]{4}-[0-9]{2}-[0-9]{2}"))
  lt_calc <- interval(pub_date, valid_date) %/% months(1)
  lt_fname <- as.integer(str_extract(fname, "(?<=_L)[0-9]"))

  tibble(
    filename = fname,
    pub_date = pub_date,
    valid_date = valid_date,
    lt_calculated = lt_calc,
    lt_filename = lt_fname,
    match = lt_calc == lt_fname
  )
})

results |> knitr::kable()
```

**Result:** All calculated leadtimes match filename leadtimes.

## Check 5: NetCDF Structure

Inspect raw NetCDF structure to confirm variable names and dimensions.

```{r}
#| label: check-structure

fp <- file.path(forecast_dir, "CFSv2_PRCP/2020/starJan/MME_deterministic_forecast_Feb_Jan2020_L1.nc")
dat <- open.nc(fp)

X <- var.get.nc(dat, "X")
Y <- var.get.nc(dat, "Y")
value_array <- var.get.nc(dat, "deterministic")

cat("X (longitude):", length(X), "values, range:", min(X), "to", max(X), "\n")
cat("Y (latitude):", length(Y), "values, range:", min(Y), "to", max(Y), "\n")
cat("deterministic array: dim =", paste(dim(value_array), collapse = " x "), "\n")
cat("  min:", round(min(value_array, na.rm = TRUE), 2), "mm\n")
cat("  max:", round(max(value_array, na.rm = TRUE), 2), "mm\n")
cat("  mean:", round(mean(value_array, na.rm = TRUE), 2), "mm\n")
cat("  NA count:", sum(is.na(value_array)), "of", length(value_array), "(ocean/outside Guatemala)\n")

close.nc(dat)
```

## Summary

| Check | Status | Notes |
|-------|--------|-------|
| Array transposition | ✅ | `aperm(c(2,1))` required for correct spatial alignment |
| Units | ✅ | Monthly precipitation totals in mm (no conversion needed) |
| Date extraction | ✅ | T and S attributes correctly parsed |
| Leadtime calculation | ✅ | `interval(pub_date, valid_date) %/% months(1)` works correctly |
| Model consistency | ✅ | All 3 models have same structure and reasonable values |
| Spatial alignment | ✅ | Chiquimula boundary overlays correctly on raster |

**Conclusion:** The data pipeline is reading INSIVUMEH NetCDF files correctly.
